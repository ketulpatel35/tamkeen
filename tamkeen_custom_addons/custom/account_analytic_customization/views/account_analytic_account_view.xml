<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record model="ir.actions.act_window" id="action_sales_order">
        <field name="name">Sales Orders</field>
        <field name="res_model">sale.order</field>
        <field name="src_model">account.analytic.account</field>
        <field name="help" type="html">
            <p class="oe_view_nocontent_create">
                Click to create a quotation that can be converted into a sales
                order.
            </p>
            <p>
                Use sale orders to track everything that should be invoiced
                at a fix price on a contract.
            </p>
        </field>
    </record>

    <record id="account_analytic_account_form_int_01" model="ir.ui.view">
        <field name="name">account.analytic.account.form.int.view.01</field>
        <field name="model">account.analytic.account</field>
        <field name="type">form</field>
        <field name="inherit_id"
               ref="analytic.view_account_analytic_account_form"/>
        <field name="arch" type="xml">
            <xpath expr="//sheet" position="before">
                <header>
                    <button name="set_pending" string="To Renew" type="object"
                            states="open"/>
                    <button name="set_close" string="Close Contract"
                            type="object" states="open,pending"/>
                    <button name="set_open" string="Set In Progress"
                            type="object"
                            states="pending,close,cancelled,draft"/>
                    <button name="set_cancel" string="Cancel Contract"
                            type="object" states="open,pending"/>
                    <field name="state" readonly="1" widget="statusbar"
                           statusbar_visible="open,pending,close"
                           statusbar_colors='{"pending":"red", "template":"blue"}'/>
                </header>
            </xpath>
        </field>
    </record>


    <record id="account_analytic_account_form_int" model="ir.ui.view">
        <field name="name">account.analytic.account.form.int.view</field>
        <field name="model">account.analytic.account</field>
        <field name="type">form</field>
        <field name="inherit_id"
               ref="account_budget.view_account_analytic_account_form_inherit_budget"/>
        <field name="arch" type="xml">
            <field name="tag_ids" position="before">
                <field name="type"/>
                <field name="template_id"
                       attrs="{'invisible': [('type','in',['view', 'normal', 'template'])]}"
                       domain="[('type','=','template')]"
                       context="{'default_type' : 'template'}"/>
            </field>
            <xpath expr="//notebook" position="inside">
                <page string="Contract Information" name="contract_page"
                      attrs="{'invisible':[('type','not in',['contract', 'template'])]}">
                    <group string="Renewal" name="contract">
                        <p colspan="2" class="oe_grey oe_edit_only">
                            Once the end date of the contract is
                            passed or the maximum number of service
                            units (e.g. support contract) is
                            reached, the account manager is notified
                            by email to renew the contract with the
                            customer.
                        </p>
                        <field name="date_start"/>
                        <label for="date" string="End Date"/>
                        <div name="duration">
                            <field name="date" class="oe_inline"/>
                        </div>
                    </group>
                    <group>
                        <field name="pricelist_id"/>
                    </group>
                    <group string="Invoicing" name="invoicing">
                        <table class="oe_form_analytic_account">
                            <tr>
                                <th class="oe_timesheet_grey"
                                    width="160px"></th>
                                <th class="oe_timesheet_grey"
                                    width="25px"></th>
                                <th class="oe_timesheet_grey" width="100px">
                                    <label string="Expected"/>
                                </th>
                                <th class="oe_timesheet_grey" width="100px">
                                    <label string="Invoiced"/>
                                </th>
                                <th class="oe_timesheet_grey" width="100px">
                                    <label string="Remaining"/>
                                </th>
                                <th class="oe_timesheet_grey" width="100px">
                                    <label string="To Invoice"/>
                                </th>
                                <th width="30px"></th>
                                <th></th>
                            </tr>
                            <tr>
                                <td class="oe_timesheet_grey">
                                    <label for="fix_price_invoices"/>
                                </td>
                                <td class="oe_timesheet_grey">
                                    <field name="fix_price_invoices"
                                           class="oe_inline"/>
                                </td>
                                <td>
                                    <field class="oe_inline" name="amount_max"
                                           attrs="{'invisible': [('fix_price_invoices','=',False)]}"/>
                                </td>
                                <td>
                                    <field class="oe_inline" name="ca_invoiced"
                                           attrs="{'invisible': [('fix_price_invoices','=',False)]}"/>
                                </td>
                                <td>
                                    <field class="oe_inline"
                                           name="remaining_ca"
                                           attrs="{'invisible': [('fix_price_invoices','=',False)]}"/>
                                </td>
                                <td>
                                    <field class="oe_inline"
                                           name="fix_price_to_invoice"
                                           attrs="{'invisible': [('fix_price_invoices','=',False)]}"/>
                                </td>
                                <td attrs="{'invisible': [('fix_price_invoices','=',False)]}"
                                    class="oe_timesheet_action">
                                    <span attrs="{'invisible': [('fix_price_to_invoice','=',0.0)]}"
                                          class="oe_grey">
                                        <button name="open_sale_order_lines"
                                                class="oe_link"
                                                string="⇒ Invoice"
                                                type="object"
                                                context="{'default_partner_id': [partner_id],'default_project_id': active_id,'search_default_uninvoiced': 1,'search_default_project_id': active_id,'search_default_partner_id': [partner_id]}"/>
                                        or view
                                    </span>

                                    <span attrs="{'invisible': [('fix_price_to_invoice','&lt;&gt;',0.0 )]}"
                                          class="oe_grey">
                                        No order to invoice, create
                                    </span>
                                    <button name="%(action_sales_order)d"
                                            string="Sales Orders"
                                            type="action"
                                            class="oe_link"
                                            context="{'default_partner_id': [partner_id], 'search_default_project_id': [active_id],'default_project_id': [active_id], 'default_pricelist_id': pricelist_id}"
                                    />
                                </td>
                            </tr>
                            <tr name='total'>
                                <th class="oe_timesheet_grey">
                                    <label string="Total"/>
                                </th>
                                <td class="oe_timesheet_grey">
                                </td>
                                <td class="oe_timesheet_grey">
                                    <field name="est_total" class="oe_inline"/>
                                </td>
                                <td class="oe_timesheet_grey">
                                    <field name="invoiced_total"
                                           class="oe_inline"/>
                                </td>
                                <td class="oe_timesheet_grey">
                                    <field name="remaining_total"
                                           class="oe_inline"/>
                                </td>
                                <td class="oe_timesheet_grey">
                                    <field name="toinvoice_total"
                                           class="oe_inline"/>
                                </td>
                                <td>
                                </td>
                            </tr>
                        </table>
                    </group>
                    <separator string="Recurring Invoices"
                               attrs="{'invisible': [('recurring_invoices','!=',True)]}"/>
                    <div>
                        <div attrs="{'invisible': [('type','!=', 'contract'), ('recurring_invoices', '=', False)]}">
                            <field name="recurring_invoices"
                                   class="oe_inline"/>
                            <label for="recurring_invoices"/>
                        </div>
                        <button class="oe_link" name="recurring_create_invoice"
                                attrs="{'invisible': [('recurring_invoices','!=',True)]}"
                                string="⇒ create invoices" type="object"
                                groups="base.group_no_one"/>
                    </div>
                    <group attrs="{'invisible': [('recurring_invoices','!=',True)]}">
                        <label for="recurring_interval"/>
                        <div>
                            <field name="recurring_interval" class="oe_inline"
                                   attrs="{'required': [('recurring_invoices', '=', True)]}"/>
                            <field name="recurring_rule_type" class="oe_inline"
                                   attrs="{'required': [('recurring_invoices', '=', True)]}"/>
                        </div>
                        <field name="recurring_next_date"/>
                    </group>
                    <label for="recurring_invoice_line_ids"
                           attrs="{'invisible': [('recurring_invoices','=',False)]}"/>
                    <div attrs="{'invisible': [('recurring_invoices','=',False)]}">
                        <field name="recurring_invoice_line_ids">
                            <tree string="Account Analytic Lines"
                                  editable="bottom">
                                <field name="product_id"/>
                                <field name="name"/>
                                <field name="quantity"/>
                                <field name="uom_id"/>
                                <field name="price_unit"/>
                                <field name="price_subtotal"/>
                            </tree>
                        </field>
                    </div>
                    <separator string="Terms and Conditions"
                               name="description"/>
                    <field name="description"/>
                </page>

            </xpath>
        </field>
    </record>

</odoo>
